<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misskey Theme Editor ä¸»é¢˜ç¼–è¾‘å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.1s ease, border-color 0.1s ease;
        }

        body {
            background-color: var(--bg);
            color: var(--fg);
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
            line-height: 1.5;
            padding: 2rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .theme-showcase {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .page-header {
            background-color: var(--pageHeaderBg);
            color: var(--pageHeaderFg);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border-left: 6px solid var(--accent);
            box-shadow: 0 4px 12px var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-header h1 {
            font-size: 1.6rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent), var(--buttonGradateB));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .theme-toggle {
            display: flex;
            gap: 0.5rem;
            background: var(--panel);
            padding: 0.3rem;
            border-radius: 40px;
            border: 1px solid var(--divider);
        }

        .theme-toggle button {
            background: transparent;
            border: none;
            padding: 0.4rem 1.2rem;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            color: var(--fg);
            font-size: 0.9rem;
            transition: 0.1s;
        }

        .theme-toggle button.active {
            background-color: var(--accent);
            color: var(--fgOnAccent);
        }

        .chip {
            background-color: var(--panel);
            padding: 0.3rem 1rem;
            border-radius: 30px;
            font-size: 0.85rem;
            color: var(--fgHighlighted);
            border: solid 1px var(--divider);
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1.3fr 2fr;
            gap: 1.5rem;
        }

        .variables-panel {
            background-color: var(--panel);
            border-radius: 20px;
            padding: 1.25rem;
            box-shadow: 0 8px 20px var(--shadow);
            border: solid 1px var(--divider);
            backdrop-filter: blur(2px);
            height: fit-content;
            max-height: 80vh;
            overflow-y: auto;
        }

        .variables-panel h2 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 1px solid var(--divider);
            padding-bottom: 0.6rem;
            position: sticky;
            top: 0;
            background-color: var(--panel);
            z-index: 2;
        }

        .color-grid {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .color-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            background-color: var(--panelHighlight);
            padding: 0.4rem 0.6rem;
            border-radius: 30px;
            border: 1px solid var(--divider);
            flex-wrap: wrap;
        }

        .color-swatch {
            width: 28px;
            height: 28px;
            border-radius: 30px;
            border: 2px solid var(--fgOnWhite);
            box-shadow: 0 2px 5px var(--shadow);
            flex-shrink: 0;
            cursor: pointer;
        }

        .color-info {
            flex: 1;
            min-width: 150px;
        }

        .color-name {
            color: var(--hashtag);
            font-weight: 600;
            display: inline-block;
            margin-right: 0.5rem;
        }

        .color-desc {
            color: var(--fg);
            opacity: 0.7;
            font-size: 0.7rem;
            display: block;
            margin-top: 2px;
        }

        .color-value {
            color: var(--codeString);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            word-break: break-word;
            background: var(--bg);
            padding: 0.1rem 0.3rem;
            border-radius: 12px;
        }

        .color-picker {
            width: 32px;
            height: 32px;
            border: 2px solid var(--divider);
            border-radius: 30px;
            cursor: pointer;
            flex-shrink: 0;
            background: transparent;
        }
        .color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        .color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 30px;
        }

        .ui-showcase { display: flex; flex-direction: column; gap: 1.5rem; }
        .window-card { background-color: var(--panel); border-radius: 24px; padding: 1.5rem; border: 1px solid var(--divider); box-shadow: 0 12px 28px var(--shadow); }
        .window-header { background-color: var(--windowHeader); margin: -1.5rem -1.5rem 1rem -1.5rem; padding: 1rem 1.5rem; border-top-left-radius: 24px; border-top-right-radius: 24px; border-bottom: 1px solid var(--divider); color: var(--fg); font-weight: 500; backdrop-filter: blur(8px); display: flex; align-items: center; gap: 12px; }
        .window-header .indicator { width: 12px; height: 12px; background-color: var(--indicator); border-radius: 20px; }
        .nav-row { background-color: var(--navBg); border-radius: 40px; padding: 0.3rem; display: inline-flex; border: 1px solid var(--divider); margin-bottom: 1.2rem; }
        .nav-item { padding: 0.5rem 1.2rem; border-radius: 30px; color: var(--navFg); font-weight: 500; font-size: 0.9rem; cursor: default; }
        .nav-item.active { background-color: var(--navActive); color: var(--fgOnAccent); box-shadow: 0 2px 8px var(--shadow); }
        .nav-item .indicator { display: inline-block; width: 8px; height: 8px; background-color: var(--navIndicator); border-radius: 10px; margin-left: 6px; }
        .note { background-color: var(--messageBg); border-radius: 20px; padding: 1.2rem; border: 1px solid var(--divider); margin-bottom: 1.2rem; }
        .note-header { display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.8rem; }
        .note-avatar { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(145deg, var(--accent), var(--renote)); }
        .note-name { font-weight: 600; color: var(--fgHighlighted); }
        .note-username { color: var(--fg); opacity: 0.6; font-size: 0.8rem; }
        .note-content { color: var(--fg); padding-left: 0.5rem; border-left: 3px solid var(--accent); }
        .mention { color: var(--mention); background-color: var(--accentedBg); padding: 0.1rem 0.3rem; border-radius: 8px; }
        .hashtag { color: var(--hashtag); }
        .renote-indicator { color: var(--renote); font-size: 0.8rem; margin-top: 0.5rem; }
        .button-group { display: flex; flex-wrap: wrap; gap: 12px; margin: 1.2rem 0; }
        .btn { padding: 0.5rem 1.4rem; border-radius: 40px; border: none; font-weight: 600; font-size: 0.9rem; cursor: default; background-color: var(--buttonBg); color: var(--fg); border: 1px solid var(--inputBorder); }
        .btn-primary { background: linear-gradient(145deg, var(--buttonGradateA), var(--buttonGradateB)); color: var(--fgOnAccent); border: none; }
        .btn-hover { background-color: var(--buttonHoverBg); }
        .switch-group { display: flex; gap: 24px; align-items: center; margin: 1rem 0; }
        .switch { width: 48px; height: 24px; background-color: var(--switchOffBg); border-radius: 30px; position: relative; border: 1px solid var(--divider); }
        .switch.on { background-color: var(--switchOnBg); }
        .switch::after { content: ""; display: block; width: 20px; height: 20px; background-color: var(--switchOffFg); border-radius: 50%; position: relative; top: 1px; left: 2px; }
        .switch.on::after { background-color: var(--switchOnFg); left: 24px; }
        .input-field { background-color: var(--bg); border: 1px solid var(--inputBorder); border-radius: 30px; padding: 0.6rem 1.2rem; color: var(--fg); width: 100%; margin: 0.5rem 0; }
        .input-field:focus { border-color: var(--inputBorderHover); outline: none; }
        .badge { background-color: var(--badge); color: var(--fgOnAccent); padding: 0.15rem 0.6rem; border-radius: 40px; font-size: 0.7rem; font-weight: 600; }
        .info-box { background-color: var(--infoBg); color: var(--infoFg); padding: 0.8rem 1rem; border-radius: 16px; border-left: 6px solid var(--infoWarnBg); }
        .divider-example { height: 2px; background-color: var(--divider); margin: 1rem 0; }
        .scrollable-area { max-height: 120px; overflow-y: auto; background-color: var(--bg); padding: 0.8rem; border-radius: 16px; border: 1px solid var(--divider); }
        .scrollable-area::-webkit-scrollbar { width: 8px; }
        .scrollable-area::-webkit-scrollbar-thumb { background-color: var(--scrollbarHandle); border-radius: 10px; }
        .scrollable-area::-webkit-scrollbar-thumb:hover { background-color: var(--scrollbarHandleHover); }

        .export-area {
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        .export-buttons {
            display: flex;
            gap: 0.8rem;
            justify-content: flex-end;
        }
        .export-btn {
            background-color: var(--accent);
            color: var(--fgOnAccent);
            border: none;
            padding: 0.6rem 1.8rem;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            border: 1px solid var(--divider);
        }
        .export-btn:hover {
            background-color: var(--buttonGradateB);
        }
        .copy-btn {
            background-color: var(--panel);
            color: var(--fg);
            border: 1px solid var(--divider);
            padding: 0.6rem 1.8rem;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
        }
        .copy-btn:hover {
            background-color: var(--panelHighlight);
        }
        .export-code {
            width: 100%;
            background-color: var(--panel);
            border: 1px solid var(--divider);
            border-radius: 16px;
            padding: 1rem;
            color: var(--codeString);
            font-family: monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow: auto;
        }

        a { color: var(--link); }
    </style>
</head>
<body>
    <div class="theme-showcase" id="app"></div>

    <script>
        (function() {
            // ---------- æ·±è‰²ä¸»é¢˜ (åŸå§‹) ----------
            const DARK_THEME = {
                accent: '#f29924',
                accentedBg: ':alpha<0.15<@accent',
                love: '#dd2e44',
                focus: ':alpha<0.3<@accent',
                bg: '#191919',
                fg: '#dadada',
                fgHighlighted: ':lighten<3<@fg',
                fgOnAccent: '#fff',
                fgOnWhite: '#333',
                divider: 'rgba(255, 255, 255, 0.1)',
                indicator: '@accent',
                panel: ':lighten<3<@bg',
                panelHighlight: ':lighten<3<@panel',
                panelHeaderBg: ':lighten<3<@panel',
                panelHeaderFg: '@fg',
                panelBorder: '" solid 1px var(--MI_THEME-divider)',
                windowHeader: ':alpha<0.85<@panel',
                popup: ':lighten<3<@panel',
                shadow: 'rgba(0, 0, 0, 0.3)',
                header: ':alpha<0.7<@panel',
                navBg: '@panel',
                navFg: '@fg',
                navActive: '@accent',
                navIndicator: '@indicator',
                pageHeaderBg: '@bg',
                pageHeaderFg: '@fg',
                link: '#44a4c1',
                hashtag: '#ff9156',
                mention: '@accent',
                mentionMe: '@mention',
                renote: '#229e82',
                modalBg: 'rgba(0, 0, 0, 0.5)',
                scrollbarHandle: 'rgba(255, 255, 255, 0.2)',
                scrollbarHandleHover: 'rgba(255, 255, 255, 0.4)',
                dateLabelFg: '@fg',
                infoBg: '#253142',
                infoFg: '#fff',
                infoWarnBg: '#42321c',
                infoWarnFg: '#ffbd3e',
                folderHeaderBg: 'rgba(255, 255, 255, 0.05)',
                folderHeaderHoverBg: 'rgba(255, 255, 255, 0.1)',
                buttonBg: ':lighten<5<@panel',
                buttonHoverBg: ':lighten<10<@panel',
                buttonGradateA: '@accent',
                buttonGradateB: ':hue<20<@accent',
                switchBg: 'rgba(255, 255, 255, 0.15)',
                switchOffBg: 'rgba(255, 255, 255, 0.1)',
                switchOffFg: ':alpha<0.8<@fg',
                switchOnBg: '@accentedBg',
                switchOnFg: '@accent',
                inputBorder: 'rgba(255, 255, 255, 0.1)',
                inputBorderHover: 'rgba(255, 255, 255, 0.2)',
                badge: '#31b1ce',
                messageBg: '@bg',
                success: '#86b300',
                error: '#ec4137',
                warn: '#ecb637',
                codeString: '#ffb675',
                codeNumber: '#cfff9e',
                codeBoolean: '#c59eff',
                deckBg: '#000',
                htmlThemeColor: '@bg',
            };

            // ---------- æµ…è‰²ä¸»é¢˜ ----------
            const LIGHT_THEME = {
                accent: '#f29924',
                accentedBg: ':alpha<0.15<@accent',
                love: '#dd2e44',
                focus: ':alpha<0.3<@accent',
                bg: '#f5f5f5',
                fg: '#1a1a1a',
                fgHighlighted: ':lighten<3<@fg',
                fgOnAccent: '#fff',
                fgOnWhite: '#333',
                divider: 'rgba(0, 0, 0, 0.1)',
                indicator: '@accent',
                panel: ':lighten<3<@bg',
                panelHighlight: ':lighten<3<@panel',
                panelHeaderBg: ':lighten<3<@panel',
                panelHeaderFg: '@fg',
                panelBorder: '" solid 1px var(--MI_THEME-divider)',
                windowHeader: ':alpha<0.85<@panel',
                popup: ':lighten<3<@panel',
                shadow: 'rgba(0, 0, 0, 0.1)',
                header: ':alpha<0.7<@panel',
                navBg: '@panel',
                navFg: '@fg',
                navActive: '@accent',
                navIndicator: '@indicator',
                pageHeaderBg: '@bg',
                pageHeaderFg: '@fg',
                link: '#0066a1',
                hashtag: '#cc5b1a',
                mention: '@accent',
                mentionMe: '@mention',
                renote: '#1e7a65',
                modalBg: 'rgba(0, 0, 0, 0.3)',
                scrollbarHandle: 'rgba(0, 0, 0, 0.2)',
                scrollbarHandleHover: 'rgba(0, 0, 0, 0.4)',
                dateLabelFg: '@fg',
                infoBg: '#d9e6f2',
                infoFg: '#111',
                infoWarnBg: '#f7e0b0',
                infoWarnFg: '#8a6e2b',
                folderHeaderBg: 'rgba(0, 0, 0, 0.03)',
                folderHeaderHoverBg: 'rgba(0, 0, 0, 0.07)',
                buttonBg: ':lighten<5<@panel',
                buttonHoverBg: ':lighten<10<@panel',
                buttonGradateA: '@accent',
                buttonGradateB: ':hue<20<@accent',
                switchBg: 'rgba(0, 0, 0, 0.15)',
                switchOffBg: 'rgba(0, 0, 0, 0.1)',
                switchOffFg: ':alpha<0.8<@fg',
                switchOnBg: '@accentedBg',
                switchOnFg: '@accent',
                inputBorder: 'rgba(0, 0, 0, 0.15)',
                inputBorderHover: 'rgba(0, 0, 0, 0.25)',
                badge: '#1f8a9c',
                messageBg: '@bg',
                success: '#2e7d32',
                error: '#b71c1c',
                warn: '#b76e1e',
                codeString: '#b45f3a',
                codeNumber: '#1f7a5a',
                codeBoolean: '#7245b3',
                deckBg: '#e0e0e0',
                htmlThemeColor: '@bg',
            };

            // ---------- ä¸­æ–‡æ³¨é‡Š ----------
            const CHINESE_DESC = {
                accent: 'å¼ºè°ƒè‰²/å“ç‰Œæ©™',
                accentedBg: 'å¼ºè°ƒè‰²èƒŒæ™¯ (åŠé€æ˜)',
                love: 'å–œæ¬¢/æ”¶è—è‰²',
                focus: 'ç„¦ç‚¹æŒ‡ç¤º (åŠé€æ˜)',
                bg: 'é¡µé¢èƒŒæ™¯è‰²',
                fg: 'é»˜è®¤æ–‡å­—é¢œè‰²',
                fgHighlighted: 'é«˜äº®æ–‡å­—',
                fgOnAccent: 'å¼ºè°ƒè‰²ä¸Šçš„æ–‡å­—',
                fgOnWhite: 'ç™½è‰²èƒŒæ™¯ä¸Šçš„æ–‡å­—',
                divider: 'åˆ†å‰²çº¿é¢œè‰²',
                indicator: 'æœªè¯»/æŒ‡ç¤ºå™¨é¢œè‰²',
                panel: 'é¢æ¿èƒŒæ™¯',
                panelHighlight: 'é¢æ¿é«˜äº®',
                panelHeaderBg: 'é¢æ¿å¤´éƒ¨èƒŒæ™¯',
                panelHeaderFg: 'é¢æ¿å¤´éƒ¨æ–‡å­—',
                panelBorder: 'é¢æ¿è¾¹æ¡†æ ·å¼ (ç‰¹æ®Š)',
                windowHeader: 'çª—å£å¤´éƒ¨ (åŠé€æ˜)',
                popup: 'å¼¹å‡ºå±‚èƒŒæ™¯',
                shadow: 'é˜´å½±é¢œè‰²',
                header: 'é¡¶æ èƒŒæ™¯ (åŠé€æ˜)',
                navBg: 'å¯¼èˆªèƒŒæ™¯',
                navFg: 'å¯¼èˆªæ–‡å­—',
                navActive: 'å¯¼èˆªæ¿€æ´»é¡¹',
                navIndicator: 'å¯¼èˆªæŒ‡ç¤ºå™¨',
                pageHeaderBg: 'é¡µé¢å¤´éƒ¨èƒŒæ™¯',
                pageHeaderFg: 'é¡µé¢å¤´éƒ¨æ–‡å­—',
                link: 'é“¾æ¥é¢œè‰²',
                hashtag: 'è¯é¢˜æ ‡ç­¾é¢œè‰²',
                mention: 'æåŠé¢œè‰²',
                mentionMe: 'æåŠè‡ªå·±é¢œè‰²',
                renote: 'ç¬¬äºŒä¸»é¢˜è‰²/è½¬è´´é¢œè‰²',
                modalBg: 'æ¨¡æ€æ¡†é®ç½©',
                scrollbarHandle: 'æ»šåŠ¨æ¡æ»‘å—',
                scrollbarHandleHover: 'æ»šåŠ¨æ¡æ»‘å—æ‚¬åœ',
                dateLabelFg: 'æ—¥æœŸæ ‡ç­¾æ–‡å­—',
                infoBg: 'ä¿¡æ¯æç¤ºèƒŒæ™¯',
                infoFg: 'ä¿¡æ¯æç¤ºæ–‡å­—',
                infoWarnBg: 'è­¦å‘Šæç¤ºèƒŒæ™¯',
                infoWarnFg: 'è­¦å‘Šæç¤ºæ–‡å­—',
                folderHeaderBg: 'æ–‡ä»¶å¤¹å¤´éƒ¨èƒŒæ™¯',
                folderHeaderHoverBg: 'æ–‡ä»¶å¤¹å¤´éƒ¨æ‚¬åœ',
                buttonBg: 'æŒ‰é’®èƒŒæ™¯',
                buttonHoverBg: 'æŒ‰é’®æ‚¬åœèƒŒæ™¯',
                buttonGradateA: 'æ¸å˜æŒ‰é’®èµ·ç‚¹ (æ¥è‡ªå¼ºè°ƒè‰²)',
                buttonGradateB: 'æ¸å˜æŒ‰é’®ç»ˆç‚¹ (å¯ç‹¬ç«‹ç¼–è¾‘)',
                switchBg: 'å¼€å…³èƒŒæ™¯',
                switchOffBg: 'å¼€å…³å…³é—­èƒŒæ™¯',
                switchOffFg: 'å¼€å…³å…³é—­æ»‘å—',
                switchOnBg: 'å¼€å…³å¼€å¯èƒŒæ™¯',
                switchOnFg: 'å¼€å…³å¼€å¯æ»‘å—',
                inputBorder: 'è¾“å…¥æ¡†è¾¹æ¡†',
                inputBorderHover: 'è¾“å…¥æ¡†è¾¹æ¡†æ‚¬åœ',
                badge: 'å¾½ç« èƒŒæ™¯',
                messageBg: 'æ¶ˆæ¯èƒŒæ™¯',
                success: 'æˆåŠŸè‰²',
                error: 'é”™è¯¯è‰²',
                warn: 'è­¦å‘Šè‰²',
                codeString: 'ä»£ç å­—ç¬¦ä¸²é¢œè‰²',
                codeNumber: 'ä»£ç æ•°å­—é¢œè‰²',
                codeBoolean: 'ä»£ç å¸ƒå°”å€¼é¢œè‰²',
                deckBg: 'å¤šæ æ¨¡å¼èƒŒæ™¯',
                htmlThemeColor: 'æµè§ˆå™¨ä¸»é¢˜é¢œè‰²',
            };

            // ---------- å·¥å…·å‡½æ•° ----------
            function parseColor(str) {
                if (!str) return null;
                str = str.trim();
                if (str.startsWith('#')) {
                    let hex = str.slice(1);
                    if (hex.length === 3) hex = hex.split('').map(c => c + c).join('');
                    if (hex.length === 6) {
                        const r = parseInt(hex.slice(0, 2), 16) / 255;
                        const g = parseInt(hex.slice(2, 4), 16) / 255;
                        const b = parseInt(hex.slice(4, 6), 16) / 255;
                        return { r, g, b, a: 1 };
                    }
                }
                const rgbaMatch = str.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([0-9.]+))?\)/);
                if (rgbaMatch) {
                    const r = parseInt(rgbaMatch[1]) / 255;
                    const g = parseInt(rgbaMatch[2]) / 255;
                    const b = parseInt(rgbaMatch[3]) / 255;
                    const a = rgbaMatch[4] ? parseFloat(rgbaMatch[4]) : 1;
                    return { r, g, b, a };
                }
                return null;
            }

            function rgbToHsl({ r, g, b, a }) {
                const max = Math.max(r, g, b), min = Math.min(r, g, b);
                let h, s, l = (max + min) / 2;
                if (max === min) {
                    h = s = 0;
                } else {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch (max) {
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                    }
                    h /= 6;
                }
                return { h, s, l, a };
            }

            function hslToRgb({ h, s, l, a }) {
                let r, g, b;
                if (s === 0) {
                    r = g = b = l;
                } else {
                    const hue2rgb = (p, q, t) => {
                        if (t < 0) t += 1;
                        if (t > 1) t -= 1;
                        if (t < 1/6) return p + (q - p) * 6 * t;
                        if (t < 1/2) return q;
                        if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                        return p;
                    };
                    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    const p = 2 * l - q;
                    r = hue2rgb(p, q, h + 1/3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1/3);
                }
                return { r, g, b, a };
            }

            function formatRgb({ r, g, b, a }) {
                if (a >= 0.999) {
                    return `#${[r, g, b].map(c => Math.round(c * 255).toString(16).padStart(2, '0')).join('')}`;
                } else {
                    return `rgba(${Math.round(r * 255)}, ${Math.round(g * 255)}, ${Math.round(b * 255)}, ${a.toFixed(2)})`;
                }
            }

            function toHex(colorStr) {
                const c = parseColor(colorStr);
                if (!c) return null;
                return `#${[c.r, c.g, c.b].map(v => Math.round(v * 255).toString(16).padStart(2, '0')).join('')}`;
            }

            function lighten(colorStr, amount) {
                const c = parseColor(colorStr);
                if (!c) return colorStr;
                const hsl = rgbToHsl(c);
                hsl.l = Math.min(1, hsl.l + (amount / 100));
                return formatRgb(hslToRgb(hsl));
            }
            function alpha(colorStr, amount) {
                const c = parseColor(colorStr);
                if (!c) return colorStr;
                c.a = Math.min(1, Math.max(0, amount));
                return formatRgb(c);
            }
            function hue(colorStr, degrees) {
                const c = parseColor(colorStr);
                if (!c) return colorStr;
                const hsl = rgbToHsl(c);
                hsl.h = (hsl.h + (degrees / 360)) % 1;
                if (hsl.h < 0) hsl.h += 1;
                return formatRgb(hslToRgb(hsl));
            }

            // ---------- è§£æå¼•æ“ ----------
            function resolveValue(val, ctx, cache = new Map()) {
                if (typeof val !== 'string') return val;
                val = val.trim();
                if (cache.has(val)) return cache.get(val);

                if (val.startsWith('@')) {
                    const key = val.slice(1);
                    if (ctx[key] !== undefined) {
                        const resolved = resolveValue(ctx[key], ctx, cache);
                        cache.set(val, resolved);
                        return resolved;
                    }
                    return val;
                }

                if (val.startsWith(':')) {
                    const parts = val.slice(1).split('<');
                    const func = parts[0];
                    const args = parts.slice(1);
                    let colorRef = args.pop();
                    const baseColor = resolveValue(colorRef.startsWith('@') ? colorRef : `@${colorRef}`, ctx, cache);
                    if (!baseColor) return val;

                    let result = baseColor;
                    if (func === 'alpha' && args.length > 0) {
                        result = alpha(baseColor, parseFloat(args[0]));
                    } else if (func === 'lighten' && args.length > 0) {
                        result = lighten(baseColor, parseFloat(args[0]));
                    } else if (func === 'hue' && args.length > 0) {
                        result = hue(baseColor, parseFloat(args[0]));
                    }
                    cache.set(val, result);
                    return result;
                }

                return val;
            }

            function evaluateTheme(theme) {
                const evaluated = {};
                const keys = Object.keys(theme);
                for (let k of keys) evaluated[k] = theme[k];

                let changed = true;
                let maxLoop = 50;
                while (changed && maxLoop-- > 0) {
                    changed = false;
                    for (let k of keys) {
                        const oldVal = evaluated[k];
                        const newVal = resolveValue(oldVal, evaluated);
                        if (newVal !== oldVal) {
                            evaluated[k] = newVal;
                            changed = true;
                        }
                    }
                }
                return evaluated;
            }

            // ---------- å…¨å±€çŠ¶æ€ ----------
            let currentTheme = JSON.parse(JSON.stringify(DARK_THEME));
            let currentMode = 'dark';

            // åˆ¤æ–­åŸºç¡€è‰²æ˜¯å¦å¯ç¼–è¾‘
            function isEditableBase(varName, rawValue) {
                if (typeof rawValue !== 'string') return false;
                // ç‰¹ä¾‹ï¼šå…è®¸ç›´æ¥ç¼–è¾‘æ¸å˜æŒ‰é’®ç»ˆç‚¹
                if (varName === 'buttonGradateB') return true;
                if (rawValue.includes('@') || rawValue.includes(':')) return false;
                return rawValue.startsWith('#') || rawValue.startsWith('rgb');
            }

            // åº”ç”¨CSSå˜é‡ï¼ˆæ— æ¸²æŸ“ï¼‰
            function applyCssVars(final) {
                let cssVars = ':root {\n';
                for (let [key, value] of Object.entries(final)) {
                    if (typeof value === 'string' && (value.startsWith('#') || value.startsWith('rgb'))) {
                        cssVars += `  --${key}: ${value};\n`;
                    } else if (key === 'divider' || key.includes('Bg') || key.includes('Fg') || key.includes('color')) {
                        cssVars += `  --${key}: ${value};\n`;
                    }
                }
                cssVars += `  --MI_THEME-divider: ${final.divider};\n`;
                cssVars += '}\n';

                let styleEl = document.getElementById('dynamic-theme-vars');
                if (!styleEl) {
                    styleEl = document.createElement('style');
                    styleEl.id = 'dynamic-theme-vars';
                    document.head.appendChild(styleEl);
                }
                styleEl.innerHTML = cssVars;
            }

            // å¢é‡æ›´æ–°
            function incrementalUpdate(final) {
                applyCssVars(final);
                document.querySelectorAll('.color-item[data-var]').forEach(item => {
                    const varName = item.dataset.var;
                    const val = final[varName];
                    if (!val) return;
                    const swatch = item.querySelector('.color-swatch');
                    const valueSpan = item.querySelector('.color-value');
                    if (swatch) swatch.style.backgroundColor = val;
                    if (valueSpan) valueSpan.textContent = val;
                });
            }

            // é¢œè‰²é€‰æ‹©å™¨å®æ—¶æ›´æ–°
            window.updateVarInput = function(varName, newHex) {
                if (!currentTheme.hasOwnProperty(varName)) return;
                currentTheme[varName] = newHex;
                const final = evaluateTheme(currentTheme);
                incrementalUpdate(final);
            };

            // åˆ‡æ¢æ·±æµ…æ¨¡å¼
            window.switchMode = function(mode) {
                if (mode === currentMode) return;
                currentMode = mode;
                currentTheme = JSON.parse(JSON.stringify(mode === 'dark' ? DARK_THEME : LIGHT_THEME));
                fullRefresh();
            };

            function fullRefresh() {
                const final = evaluateTheme(currentTheme);
                applyCssVars(final);
                renderLeftPanel(final);
                updateToggleButtons();
            }

            function renderLeftPanel(final) {
                const panel = document.querySelector('.variables-panel .color-grid');
                if (!panel) return;

                let html = '';
                for (let key in final) {
                    if (key === 'panelBorder') continue;
                    const val = final[key];
                    if (typeof val !== 'string' || (!val.startsWith('#') && !val.startsWith('rgb'))) continue;

                    const desc = CHINESE_DESC[key] || 'â€”';
                    const hex = toHex(val);
                    const isEditable = isEditableBase(key, currentTheme[key]);

                    html += `<div class="color-item" data-var="${key}">`;
                    html += `<div class="color-swatch" style="background: ${val};" title="ç‚¹å‡»å¤åˆ¶é¢œè‰²å€¼" onclick="navigator.clipboard?.writeText('${val}')"></div>`;
                    html += `<div class="color-info">`;
                    html += `<span class="color-name">${key}</span>`;
                    html += `<span class="color-desc">${desc}</span>`;
                    html += `<div class="color-value">${val}</div>`;
                    html += `</div>`;

                    if (isEditable && hex) {
                        html += `<input type="color" class="color-picker" value="${hex}" oninput="updateVarInput('${key}', this.value)">`;
                    } else {
                        html += `<span style="width:32px; text-align:center; opacity:0.4;">ğŸ”’</span>`;
                    }
                    html += `</div>`;
                }
                panel.innerHTML = html;
            }

            function updateToggleButtons() {
                const darkBtn = document.getElementById('mode-dark');
                const lightBtn = document.getElementById('mode-light');
                if (darkBtn && lightBtn) {
                    darkBtn.classList.toggle('active', currentMode === 'dark');
                    lightBtn.classList.toggle('active', currentMode === 'light');
                }
            }

            // ---------- ç”Ÿæˆå¸¦æŒ‡å®šæ ¼å¼çš„JSON (å¤–å±‚æ— å¼•å·é”® + å•å¼•å·å€¼ + propså°¾é€—å·) ----------
            function generateExportJSON() {
                const id = Math.random().toString(36).substring(2, 10); // 8ä½éšæœº
                const nameStr = `Misskey-Theme-Editor_${id}`;
                const base = currentMode;

                // props éƒ¨åˆ†ä½¿ç”¨æ ‡å‡† JSON å­—ç¬¦ä¸²ï¼ˆåŒå¼•å·ã€ä¸€ä¸ªç©ºæ ¼ç¼©è¿›ï¼‰
                const propsStr = JSON.stringify(currentTheme, null, 1);

                // æ‰‹åŠ¨æ„å»ºå¤–å±‚å¯¹è±¡ï¼Œé”®æ— å¼•å·ï¼Œå€¼ç”¨å•å¼•å·ï¼Œpropsåé¢åŠ é€—å·
                const lines = [];
                lines.push(`{`);
                lines.push(` id: '${id}',`);
                lines.push(` name: '${nameStr}',`);
                lines.push(` author: '@He0xD4C0@hub.captraw.com',`);
                lines.push(` base: '${base}',`);
                lines.push(` props: ${propsStr},`); // æ³¨æ„è¿™é‡Œçš„å°¾é€—å·
                lines.push(`}`);
                return lines.join('\n');
            }

            // æ˜¾ç¤ºå¯¼å‡ºä»£ç 
            window.showExportCode = function() {
                const pre = document.getElementById('exportCodeDisplay');
                const code = generateExportJSON();
                pre.textContent = code;
                pre.style.display = 'block';
            };

            // ä¸€é”®å¤åˆ¶
            window.copyExportCode = function() {
                const code = generateExportJSON();
                navigator.clipboard.writeText(code).then(() => {
                    alert('âœ… é…ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => {
                    alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
                });
            };

            // æ„å»ºUI
            function buildUI() {
                const app = document.getElementById('app');
                const final = evaluateTheme(currentTheme);

                const html = `
                    <div class="page-header">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <h1>ğŸŠ Misskey Theme Editor ä¸»é¢˜ç¼–è¾‘å™¨</h1>
                            <div class="theme-toggle">
                                <button id="mode-dark" class="${currentMode === 'dark' ? 'active' : ''}" onclick="switchMode('dark')">ğŸŒ™ æ·±è‰²</button>
                                <button id="mode-light" class="${currentMode === 'light' ? 'active' : ''}" onclick="switchMode('light')">â˜€ï¸ æµ…è‰²</button>
                            </div>
                        </div>
                        <div class="chip">ç‚¹å‡»è‰²å—å¤åˆ¶ | åŸºç¡€è‰²æ‹–æ‹½å®æ—¶é¢„è§ˆ</div>
                    </div>

                    <div class="dashboard">
                        <div class="variables-panel">
                            <h2>ğŸ¨ ä¸»é¢˜å˜é‡ Â· ä¸­æ–‡æ³¨é‡Š</h2>
                            <div class="color-grid"></div>
                        </div>

                        <div class="ui-showcase">
                            <div class="window-card">
                                <div class="window-header"><span class="indicator"></span> ä¸»é¡µæ—¶é—´çº¿ Â· Home <span class="badge" style="margin-left: auto;">âœ¨ æ–°ç¬”è®°</span></div>
                                <div class="nav-row">
                                    <span class="nav-item active">ä¸»é¡µ <span class="indicator"></span></span>
                                    <span class="nav-item">æœ¬åœ°</span><span class="nav-item">ç¤¾äº¤</span><span class="nav-item">å…¨å±€</span>
                                </div>
                                <div class="note">
                                    <div class="note-header"><div class="note-avatar"></div><div><div class="note-name">ç¥ç€ æ  <span class="note-username">@shiori@social.example</span></div></div></div>
                                    <div class="note-content">åˆšåˆšè°ƒå¥½äº†è¿™ä¸ª <span class="hashtag">#Misskeyä¸»é¢˜</span>ï¼Œaccentæ˜¯æ¸©æš–çš„ <span class="mention">@æ©™å­</span> è‰² âœ¨<br>è¿˜åŠ äº†ç‚¹ <span style="color: var(--renote);">è½¬è´´å¼ºè°ƒ</span> å’Œ <span style="color: var(--link);">é“¾æ¥é¢œè‰²</span>ã€‚</div>
                                    <div class="renote-indicator">ğŸ” ä½ å–œæ¬¢çš„äººè½¬å‘äº†</div>
                                </div>
                                <div class="button-group">
                                    <button class="btn" disabled>æ™®é€šæŒ‰é’®</button>
                                    <button class="btn btn-primary" disabled>ä¸»æ¸å˜æŒ‰é’®</button>
                                    <button class="btn btn-hover" disabled>æ‚¬åœæ•ˆæœ</button>
                                </div>
                                <div class="switch-group">
                                    <span>å¼€å…³å…³é—­</span><div class="switch"></div><span>å¼€å…³å¼€å¯</span><div class="switch on"></div>
                                </div>
                                <input class="input-field" placeholder="è¾“å…¥æ¡†ç¤ºä¾‹" value="type something..." disabled>
                                <div class="info-box"><strong>â„¹ï¸ ä¿¡æ¯æç¤º</strong> (infoBg/infoFg) è­¦å‘Š: <span style="color: var(--warn);">âš ï¸ warn</span> é”™è¯¯: <span style="color: var(--error);">âŒ error</span></div>
                                <div class="divider-example"></div>
                                <div class="scrollable-area"><p>æ»šåŠ¨æ¡é¢œè‰²ä½¿ç”¨ scrollbarHandle / hover</p><p>panel èƒŒæ™¯é€çº§å˜äº®</p><p>folderHeaderBg ç”¨äºæ–‡ä»¶å¤¹å¤´éƒ¨</p></div>
                            </div>
                            <div class="window-card" style="background-color: var(--deckBg);">
                                <div class="window-header" style="background-color: var(--header);">ä»£ç å—æ¨¡æ‹Ÿ Â· å­—ç¬¦ä¸²/æ•°å­—/å¸ƒå°”</div>
                                <div style="font-family: monospace; background: var(--bg); padding: 1rem; border-radius: 14px;">
                                    <span style="color: var(--codeString);">"hello world"</span><br>
                                    <span style="color: var(--codeNumber);">42</span><br>
                                    <span style="color: var(--codeBoolean);">true</span><br>
                                    <span style="color: var(--link);">link</span> Â· <span style="color: var(--hashtag);">#hashtag</span>
                                </div>
                                <div style="margin-top: 1rem; background-color: var(--folderHeaderBg); padding: 0.5rem; border-radius: 30px; text-align: center;">
                                    ğŸ“ folderHeaderBg
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="export-area">
                        <div class="export-buttons">
                            <button class="export-btn" onclick="showExportCode()">ğŸ“¤ æ˜¾ç¤ºé…ç½®</button>
                            <button class="copy-btn" onclick="copyExportCode()">ğŸ“‹ ä¸€é”®å¤åˆ¶</button>
                        </div>
                        <pre id="exportCodeDisplay" class="export-code" style="display: none;"></pre>
                    </div>
                `;
                app.innerHTML = html;

                renderLeftPanel(final);
                applyCssVars(final);
                updateToggleButtons();
            }

            buildUI();
        })();
    </script>
</body>
</html>